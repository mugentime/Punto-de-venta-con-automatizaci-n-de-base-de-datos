const CACHE_NAME = 'pos-conejo-negro-v1.0.0';const CACHE_VERSION = '20250912';const OFFLINE_PAGE = '/offline.html';const CRITICAL_ASSETS = [ '/','/online','/index.html','/conejo_negro_online.html','/css/mobile-optimized.css','/js/mobile-enhancements.js','/js/mobile-menu-simple.js','https:'https:];const API_CACHE_ROUTES = [ '/api/health','/api/version','/api/stats','/api/products','/api/sync/status' ];const NO_CACHE_ROUTES = [ '/api/auth/login','/api/auth/logout','/api/auth/refresh','/api/records','/api/cashcuts','/api/sync/backup' ];const CACHE_STRATEGIES ={CACHE_FIRST:'cache-first',NETWORK_FIRST:'network-first',STALE_WHILE_REVALIDATE:'stale-while-revalidate',NETWORK_ONLY:'network-only',CACHE_ONLY:'cache-only'};self.addEventListener('install',event =>{console.log('üîß Service Worker installing...');event.waitUntil(caches.open(CACHE_NAME).then(cache =>{console.log('üì¶ Pre-caching critical assets...');return cache.addAll(CRITICAL_ASSETS);}).then(()=>{console.log('‚úÖ Critical assets cached');return self.skipWaiting();}).catch(error =>{console.error('‚ùå Failed to cache critical assets:',error);}));});self.addEventListener('activate',event =>{console.log('üöÄ Service Worker activating...');event.waitUntil(caches.keys().then(cacheNames =>{const deletePromises = cacheNames .filter(name => name !== CACHE_NAME).map(name =>{console.log('üóëÔ∏è Deleting old cache:',name);return caches.delete(name);});return Promise.all(deletePromises);}).then(()=>{console.log('‚úÖ Old caches cleaned up');return self.clients.claim();}));});self.addEventListener('fetch',event =>{const request = event.request;const url = new URL(request.url);if(!request.url.startsWith('http')){return;}if(request.method !== 'GET'){return handleNetworkOnlyRequest(event);}const strategy = getCacheStrategy(url.pathname);switch(strategy){case CACHE_STRATEGIES.CACHE_FIRST:return handleCacheFirstRequest(event);case CACHE_STRATEGIES.NETWORK_FIRST:return handleNetworkFirstRequest(event);case CACHE_STRATEGIES.STALE_WHILE_REVALIDATE:return handleStaleWhileRevalidateRequest(event);case CACHE_STRATEGIES.NETWORK_ONLY:return handleNetworkOnlyRequest(event);case CACHE_STRATEGIES.CACHE_ONLY:return handleCacheOnlyRequest(event);default:return handleNetworkFirstRequest(event);}});function getCacheStrategy(pathname){if(pathname.match(/\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$/)){return CACHE_STRATEGIES.CACHE_FIRST;}if(pathname.match(/\.(html?)$/)|| pathname === '/' || pathname === '/online'){return CACHE_STRATEGIES.STALE_WHILE_REVALIDATE;}if(NO_CACHE_ROUTES.some(route => pathname.startsWith(route))){return CACHE_STRATEGIES.NETWORK_ONLY;}if(API_CACHE_ROUTES.some(route => pathname.startsWith(route))){return CACHE_STRATEGIES.NETWORK_FIRST;}if(pathname.startsWith('/api/')){return CACHE_STRATEGIES.NETWORK_FIRST;}return CACHE_STRATEGIES.CACHE_FIRST;}function handleCacheFirstRequest(event){event.respondWith(caches.match(event.request).then(cachedResponse =>{if(cachedResponse){return cachedResponse;}return fetch(event.request).then(networkResponse =>{if(networkResponse.ok){const responseClone = networkResponse.clone();caches.open(CACHE_NAME).then(cache => cache.put(event.request,responseClone));}return networkResponse;}).catch(error =>{console.error('Network request failed:',error);return createOfflineResponse();});}));}function handleNetworkFirstRequest(event){event.respondWith(fetch(event.request).then(networkResponse =>{if(networkResponse.ok){const responseClone = networkResponse.clone();caches.open(CACHE_NAME).then(cache => cache.put(event.request,responseClone));}return networkResponse;}).catch(error =>{console.log('Network failed,trying cache:',error.message);return caches.match(event.request).then(cachedResponse =>{if(cachedResponse){return cachedResponse;}return createOfflineResponse();});}));}function handleStaleWhileRevalidateRequest(event){event.respondWith(caches.match(event.request).then(cachedResponse =>{const fetchPromise = fetch(event.request).then(networkResponse =>{if(networkResponse.ok){const responseClone = networkResponse.clone();caches.open(CACHE_NAME).then(cache => cache.put(event.request,responseClone));}return networkResponse;}).catch(error =>{console.log('Background fetch failed:',error.message);});return cachedResponse || fetchPromise;}));}function handleNetworkOnlyRequest(event){event.respondWith(fetch(event.request).catch(error =>{console.error('Network-only request failed:',error);return createOfflineResponse();}));}function handleCacheOnlyRequest(event){event.respondWith(caches.match(event.request).then(cachedResponse =>{return cachedResponse || createOfflineResponse();}));}function createOfflineResponse(){return new Response(JSON.stringify({error:'Offline',message:'La aplicaci√≥n est√° funcionando sin conexi√≥n',timestamp:new Date().toISOString(),offline:true}),{status:200,statusText:'OK',headers:{'Content-Type':'application/json','Cache-Control':'no-cache'}});}self.addEventListener('sync',event =>{console.log('üîÑ Background sync triggered:',event.tag);switch(event.tag){case 'pos-data-sync':event.waitUntil(syncPOSData());break;case 'offline-records':event.waitUntil(syncOfflineRecords());break;default:console.log('Unknown sync tag:',event.tag);}});async function syncPOSData(){try{console.log('üìä Syncing POS data...');const offlineData = await getOfflineData();if(offlineData.length > 0){const response = await fetch('/api/sync/offline-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(offlineData)});if(response.ok){console.log('‚úÖ Offline data synced successfully');await clearOfflineData();}else{throw new Error(`Sync failed:${response.status}`);}}await refreshCachedData();}catch(error){console.error('‚ùå Data sync failed:',error);}}async function syncOfflineRecords(){try{console.log('üìù Syncing offline records...');const offlineRecords = await getOfflineRecords();for(const record of offlineRecords){try{const response = await fetch('/api/records',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${record.token}`},body:JSON.stringify(record.data)});if(response.ok){await removeOfflineRecord(record.id);}}catch(recordError){console.error('Failed to sync record:',record.id,recordError);}}}catch(error){console.error('‚ùå Records sync failed:',error);}}self.addEventListener('message',event =>{const{type,payload}= event.data;switch(type){case 'SKIP_WAITING':self.skipWaiting();break;case 'CACHE_ASSETS':cacheAssets(payload.urls);break;case 'CLEAR_CACHE':clearCache();break;case 'GET_CACHE_SIZE':getCacheSize().then(size =>{event.ports[0].postMessage({type:'CACHE_SIZE',size});});break;default:console.log('Unknown message type:',type);}});async function cacheAssets(urls){try{const cache = await caches.open(CACHE_NAME);await cache.addAll(urls);console.log('‚úÖ Assets cached:',urls);}catch(error){console.error('‚ùå Failed to cache assets:',error);}}async function clearCache(){try{const cacheNames = await caches.keys();await Promise.all(cacheNames.map(name => caches.delete(name)));console.log('‚úÖ All caches cleared');}catch(error){console.error('‚ùå Failed to clear caches:',error);}}async function getCacheSize(){try{let totalSize = 0;const cacheNames = await caches.keys();for(const name of cacheNames){const cache = await caches.open(name);const keys = await cache.keys();for(const request of keys){const response = await cache.match(request);if(response){const blob = await response.blob();totalSize += blob.size;}}}return totalSize;}catch(error){console.error('‚ùå Failed to calculate cache size:',error);return 0;}}async function getOfflineData(){return [];}async function clearOfflineData(){}async function getOfflineRecords(){return [];}async function removeOfflineRecord(id){}async function refreshCachedData(){const cache = await caches.open(CACHE_NAME);const cachedRequests = await cache.keys();for(const request of cachedRequests){if(request.url.includes('/api/')){try{const response = await fetch(request);if(response.ok){await cache.put(request,response);}}catch(error){console.log('Failed to refresh cached data:',request.url);}}}}