#!/usr/bin/env node

/**
 * Railway Strategy Deployment Script
 * Auto-generated by Railway Backup Strategies Generator
 */

const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

const STRATEGIES = [
  "nixpacks",
  "dockerfile",
  "nodejs",
  "minimal",
  "production"
];
const PROJECT_ID = 'fed11c6d-a65a-4d93-90e6-955e16b6753f';

class StrategyDeployer {
    constructor() {
        this.currentStrategy = 0;
        this.maxRetries = 3;
    }

    async deployWithStrategy(strategyName) {
        console.log(`üöÄ Deploying with ${strategyName} strategy...`);
        
        try {
            // Copy strategy files to project root
            const strategyDir = path.join(__dirname, '..', 'strategies', strategyName);
            const railwayConfigSource = path.join(strategyDir, 'railway.json');
            const railwayConfigTarget = path.join(__dirname, '..', 'railway.json');
            
            if (fs.existsSync(railwayConfigSource)) {
                fs.copyFileSync(railwayConfigSource, railwayConfigTarget);
                console.log('‚úÖ Copied railway.json configuration');
            }
            
            // Copy Dockerfile if exists
            const dockerfileSource = path.join(strategyDir, 'Dockerfile');
            const dockerfileTarget = path.join(__dirname, '..', 'Dockerfile');
            
            if (fs.existsSync(dockerfileSource)) {
                fs.copyFileSync(dockerfileSource, dockerfileTarget);
                console.log('‚úÖ Copied Dockerfile');
            }
            
            // Deploy
            console.log('üöÇ Starting Railway deployment...');
            const { stdout, stderr } = await execAsync('railway up --detach', {
                cwd: path.join(__dirname, '..')
            });
            
            console.log('‚úÖ Deployment completed successfully!');
            console.log('Output:', stdout);
            
            return { success: true, output: stdout };
            
        } catch (error) {
            console.log(`‚ùå ${strategyName} strategy failed: ${error.message}`);
            return { success: false, error: error.message };
        }
    }

    async tryAllStrategies() {
        console.log('üîÑ RAILWAY STRATEGY DEPLOYMENT');
        console.log('============================');
        console.log(`üìä Available strategies: ${STRATEGIES.length}`);
        console.log(`üéØ Project ID: ${PROJECT_ID}\n`);
        
        for (const strategy of STRATEGIES) {
            const result = await this.deployWithStrategy(strategy);
            
            if (result.success) {
                console.log(`\nüéâ SUCCESS! Deployed using ${strategy} strategy`);
                return { success: true, strategy, result };
            }
            
            console.log(`‚ùå ${strategy} failed, trying next strategy...\n`);
        }
        
        console.log('‚ùå All strategies failed. Manual intervention required.');
        return { success: false, message: 'All strategies exhausted' };
    }

    async deploySpecific(strategyName) {
        if (!STRATEGIES.includes(strategyName)) {
            console.log(`‚ùå Unknown strategy: ${strategyName}`);
            console.log(`Available: ${STRATEGIES.join(', ')}`);
            return;
        }
        
        return await this.deployWithStrategy(strategyName);
    }
}

// Command line usage
if (require.main === module) {
    const deployer = new StrategyDeployer();
    
    const strategy = process.argv[2];
    
    if (strategy) {
        deployer.deploySpecific(strategy).catch(console.error);
    } else {
        deployer.tryAllStrategies().catch(console.error);
    }
}

module.exports = { StrategyDeployer };
